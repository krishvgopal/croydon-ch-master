﻿<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Create Arrangement</title>
</head>
<body>
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Create Arrangement</h4>
    </div>
    <div class="modal-body" style="height:580px;">

        <div id="arrangementScreen" style="display:block;height:100%">

            <p>Fill in the below to create a new arrangement</p>
            <br />
            <div style="width:45%;margin-left:10px;float:left;height:auto">
                <div class="form-group">
                    <label>Agreement Date</label>
                    <input type="text" id="agmAgreementDate" class="date-picker form-control" />
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="agmFrequency" class="form-control" onchange="refreshForm();"></select>
                </div>
                <div class="form-group">
                    <label>Starting Date</label>
                    <input type="text" id="agmStartDate" class="date-picker form-control" />
                </div>
                <div class="form-group" id="fgAgreedAmount">
                    <label>Agreed Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmAgreedAmount" class="form-control" onchange="updateAgreedAmount();" />
                    </div>
                </div>
                <div class="fcyNoShow">
                    <div class="form-group">
                        <label>No. of installments</label>
                        <input type="text" id="agmNumberOfInstallments" class="form-control" onchange="updateCalculation(3);" />
                    </div>
                </div>
            </div>
            <div style="width:45%;margin-right:10px;float:right;height:auto">
                <div class="form-group">
                    <label>Total Debt Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" class="form-control" id="agmTotalDebtAmount" class="form-control" disabled>
                    </div>
                </div>
                <div id="fcyWeekly" style="display: inline-block">
                    <div class="form-group">
                        <label>Day of week</label>
                        <select id="agmDayOfWeek" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                </div>
                <div id="fcyMonthly" style="display: none">
                    <div class="form-group">
                        <label>Day of month</label>
                        <select id="agmDayOfMonth" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                </div>
                <div id="fcyOneOff" style="display: none">
                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="text" id="agmPaymentDate" class="date-picker form-control" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="agmPaymentMethod" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Initial Downpayment Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmStartAmount" class="form-control" onchange="updateCalculation(1);">
                    </div>
                </div>
                <div class="fcyNoShow">
                    <div class="form-group">
                        <label>Installment Amount</label>
                        <div class="form-group input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-gbp"></i>
                            </span>
                            <input type="text" id="agmInstallmentAmount" class="form-control" onchange="updateCalculation(2);">
                        </div>
                    </div>
                    <div class="form-group" style="visibility: visible;">
                        <label>Last Payment Amount</label>
                        <div class="form-group input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-gbp"></i>
                            </span>
                            <input type="text" id="agmLastAmount" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="width:100%;clear:both;margin-top:440px">
                <button type="button" class="btn btn-default" onclick="showSchedule();">Test</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createArrangementWrapper();" id="formCreate">Create Arrangement</button>
            </div>
        </div>

        <!-- Show Schedule Ends -->

        <div id="scheduleScreen" style="display:none;height:100%">
            <p>Please review the schedule below.</p>
            <br />

            <table class="table table-striped table-bordered table-hover" id="paymentSchedule">
                <thead>
                    <tr>
                        <th>Payment Date</th>
                        <th>Payment Amount</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="modal-footer" style="width:100%;clear:both;margin-top:440px">
                <button type="button" class="btn btn-default" onclick="showArrangement();">Back</button>
                <button type="button" class="btn btn-primary" onclick="createArrangementWrapper();" id="formCreate">Create Arrangement</button>
            </div>

        </div>

    </div>

    <script>

            var currentDate = formatDate();

            //  agm_pin, agm_cd_id, agm_start_date, agm_frequency, agm_day_of_month, agm_day_of_week, agm_start_amount, agm_installment_amount, agm_number_installment, agm_payment_method, agm_agreed_amount, agm_totaldebt_amount, agm_last_amount, agm_Created_By, agm_agreement_date, agm_payment_date, agm_starting_from_date

            refreshForm();

            $('#agmTotalDebtAmount').val($('#debtRowTotalValue').val());
            $('#agmAgreedAmount').val($('#debtRowTotalValue').val());
            $("#agmNumberOfInstallments").val('1');
            $("#agmInstallmentAmount").val('0');
            $("#agmStartAmount").val('0');
            $("#agmLastAmount").val('0');
            
            $("#agmPaymentStartDate").datepicker({ dateFormat: 'dd/mm/yy' });
            $("#agmAgreementDate").datepicker({ dateFormat: 'dd/mm/yy' });
            $("#agmPaymentDate").datepicker({ dateFormat: 'dd/mm/yy' });
            $("#agmStartDate").datepicker({ dateFormat: 'dd/mm/yy' });
        
            $("#agmPaymentStartDate").val(currentDate);
            $("#agmAgreementDate").val(currentDate);
            $("#agmPaymentDate").val(currentDate);
            $("#agmStartDate").val(currentDate);
        
            loadArrangementFrequenciesList();
            loadArrangementPaymentMethodList();

            function updateCalculation(callingId) {
                
                var installmentCount = $("#agmNumberOfInstallments").val();
                var installmentAmount = $("#agmInstallmentAmount").val();
                var agreedAmount = $("#agmAgreedAmount").val();
                var lastAmount = $("#agmLastAmount").val();
                var deposit = $("#agmStartAmount").val();
                
                if (deposit == 'undefined') { $("#agmStartAmount").val('0'); }
                if (lastAmount == 'undefined') { $("#agmLastAmount").val('0'); }
                if (installmentCount == 'undefined') { $("#agmNumberOfInstallments").val('1'); }
                if (installmentAmount == 'undefined') { $("#agmInstallmentAmount").val('0'); }
                if (agreedAmount == 'undefined') { $("#agmAgreedAmountagmLastAmount").val('0'); }

                //console.log("[AGREED_AMOUNT:" + agreedAmount + ", INSTALLMENT_AMOUNT:" + installmentAmount + ", INSTALLMENT_COUNT:" + installmentCount + ", PAID_UPFRONT:" + deposit + ", LAST_AMOUNT:" + lastAmount + "]");

                // INSTALLMENT AMOUNT
                if (callingId == 2) {
                    var toClear = (agreedAmount - deposit);
                    var rawInstall = toClear / installmentAmount;
                    var cleanInstall = rawInstall.toFixed(0);
                    var cleanAllItem = cleanInstall * installmentAmount;
                    var leftOver = agreedAmount - cleanAllItem;
                    //console.log("[TO_CLEAR:" + toClear + ", RAW_INSTALLMENT_AMOUNT:" + rawInstall + ", CLEAN_INSTALLMENT_COUNT:" + cleanInstall + ", CLEAN_INSTALLMENT_AMOUNT:" + cleanAllItem + ", LAST_PAYMENT:" + leftOver + "]");
                    $("#agmNumberOfInstallments").val(cleanInstall);
                    $("#agmLastAmount").val(leftOver);
                }
                // NUMBER OF INSTALLMENTS
                if (callingId == 3 || callingId == 1) {
                    var rawCalculation = (agreedAmount - deposit) / installmentCount; // 176.833 = (1111 - 50) / 12
                    var cleanCalculation = +rawCalculation.toFixed(2); // 176.83
                    var cleanInstallments = cleanCalculation * installmentCount; // 1060.98 = 176.83 * 12
                    var rawDifference = (agreedAmount - deposit) - cleanInstallments; // 0.019999
                    var cleanDifference = +rawDifference.toFixed(2); // 0.02
                    var firstPayment = cleanDifference + cleanCalculation; // Initial  amount includes the difference
                    //console.log("[rawCalculation:" + rawCalculation + ", cleanCalculation:" + cleanCalculation + ", cleanInstallments:" + cleanInstallments + ", rawDifference:" + rawDifference + ", cleanDifference:" + cleanDifference + ", firstPayment:" + firstPayment + "]");
                    $("#agmInstallmentAmount").val(cleanCalculation.toFixed(2));
                    $("#agmLastAmount").val(firstPayment.toFixed(2));
                }
            }
            function updateAgreedAmount() {
                var agreedAmount = $('#agmAgreedAmount').val();
                var totalAmount = $('#agmTotalDebtAmount').val();
                if (agreedAmount > totalAmount) {
                    $('#fgAgreedAmount').addClass('has-error');
                    $("#formCreate").prop('disabled', true);
                } else {
                    $('#fgAgreedAmount').removeClass('has-error');
                    $("#formCreate").prop('disabled', false);
                }
            }
            function formatDate() {
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                var yyyy = today.getFullYear();
                if (dd < 10) {
                    dd = '0' + dd;
                }
                if (mm < 10) {
                    mm = '0' + mm;
                }
                return dd + '/' + mm + '/' + yyyy;
            }
            function refreshForm() {
                var selectedIndex = $("#agmFrequency").val();
                if (selectedIndex == 1) {
                    $("#fcyWeekly").show();
                    $("#fcyMonthly").hide();
                    $("#fcyOneOff").hide();
                    $(".fcyNoShow").show();
                }
                if (selectedIndex == 2) {
                    $("#fcyWeekly").hide();
                    $("#fcyMonthly").show();
                    $("#fcyOneOff").hide();
                    $(".fcyNoShow").show();
                }
                if (selectedIndex == 3) {
                    $("#fcyWeekly").hide();
                    $("#fcyMonthly").hide();
                    $("#fcyOneOff").show();
                    $(".fcyNoShow").hide();
                }
            }

            function insertRow(columnA, columnB, style) {

                //console.log( columnA + ' ' + columnB + ' ' + style );

                var table = document.getElementById("paymentSchedule");
                var row = table.insertRow(1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);

                if (style != '') {
                    cell1.innerHTML = '<i>' + columnA + '</i>';
                    cell2.innerHTML = columnB;
                } else {
                    cell1.innerHTML = columnA;
                    cell2.innerHTML = columnB;
                }
            }
            function showSchedule() {

                $("#paymentSchedule:not(:first)").remove();

                var selectedIndex = $("#agmFrequency").val();

                var instalmentFrequency = $("#agmNumberOfInstallments").val();
                var instalmentAmount = $("#agmInstallmentAmount").val();

                var paymentStartDate = $("#agmPaymentDate").val();

                var firstPaymentDate = $("#agmStartDate").val();
                var initialAmount = $("#agmStartAmount").val();
                var lastAmount = $("#agmLastAmount").val();
                var monthDay = $("#agmDayOfMonth").val();
                var weekDay = $("#agmDayOfWeek").val();
                var today = formatDate();

                // HANDLE INITIAL PAYMENTS - SHOW IN BOLD OUTSIDE OF TABLE?

                //// WEEKLY
                if (selectedIndex == 1) {
                    console.log('WEEKLY');
                    for (var i = 0; i < instalmentFrequency; i++) {
                        var newScheduleDate = moment(paymentStartDate, 'dd/mm/yy').add(i, 'weeks').format('DD/MM/YYYY');
                        if (i == (instalmentFrequency - 1)) {
                            insertRow(newScheduleDate, lastAmount, '');
                        } else {
                            insertRow(newScheduleDate, instalmentAmount, 'i');
                        }
                    }
                }

                //// MONTHLY
                if (selectedIndex == 2) {
                    console.log('MONTHLY');
                    for (var i = 0; i < instalmentFrequency; i++) {
                        var newScheduleDate = moment(paymentStartDate, 'dd/mm/yy').add(i, 'months').format('DD/MM/YYYY');
                        if (i == (instalmentFrequency - 1)) {
                            insertRow(newScheduleDate, lastAmount, '');
                        } else {
                            insertRow(newScheduleDate, instalmentAmount, 'i');
                        }
                    }
                }

                if (selectedIndex == 3) {
                    // ONE OFF PAYMENT
                    console.log('ONEOFF');
                }

                $('#arrangementScreen').hide();
                $('#scheduleScreen').show();
            }
            function showArrangement() {
                $('#scheduleScreen').hide();
                $('#arrangementScreen').show();
            }

            function createArrangementWrapper() {

                var agm_start_date              = $("#agmStartDate").val();
                var agm_frequency               = $("#agmFrequency").val();
                var agm_day_of_month            = $("#agmDayOfMonth").val();
                var agm_day_of_week             = $("#agmDayOfWeek").val();
                var agm_start_amount            = $("#agmStartAmount").val();
                var agm_installment_amount      = $("#agmInstallmentAmount").val();
                var agm_number_installment      = $("#agmNumberOfInstallments").val();
                var agm_payment_method          = $("#agmPaymentMethod").val();
                var agm_agreed_amount           = $("#agmAgreedAmount").val();
                var agm_totaldebt_amount        = $("#agmTotalDebtAmount").val();
                var agm_last_amount             = $("#agmLastAmount").val();
                var agm_agreement_date          = $("#agmAgreementDate").val();
                var agm_payment_date            = $("#agmPaymentDate").val();
                var agm_starting_from_date      = $("#agmPaymentStartDate").val();

                console.log("agm_frequency -" + agm_frequency);
                console.log("agm_day_of_month -"        + agm_day_of_month);
                console.log("agm_day_of_week -"         + agm_day_of_week);
                console.log("agm_start_amount -"        + agm_start_amount);
                console.log("agm_installment_amount -"  + agm_installment_amount);
                console.log("agm_number_installment -"  + agm_number_installment);
                console.log("agm_payment_method -"      + agm_payment_method);
                console.log("agm_agreed_amount -"       + agm_agreed_amount);
                console.log("agm_totaldebt_amount -"    + agm_totaldebt_amount);
                console.log("agm_last_amount -"         + agm_last_amount);
                console.log("agm_agreement_date -"      + agm_agreement_date);
                console.log("agm_payment_date -"        + agm_payment_date);
                console.log("agm_starting_from_date - " + agm_starting_from_date);

                //createAgreement(agm_start_date, agm_frequency, agm_day_of_month, agm_day_of_week, agm_start_amount, agm_installment_amount, agm_number_installment, agm_payment_method, agm_agreed_amount, agm_totaldebt_amount, agm_last_amount, agm_agreement_date, agm_payment_date, agm_starting_from_date);
            }

    </script>

</body>

</html>