<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Create Arrangement</title>  
</head>
    <body>
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Create Arrangement</h4>
        </div>
        <div class="modal-body" style="height:550px;">
            <p>Fill in the below to create a new arrangement</p>
            <br />
            <div style="width:45%;margin-left:10px;float:left;height:auto">
                <div class="form-group">
                    <label>Agreement Date</label>
                    <input type="text" id="agmAgreementDate" class="date-picker form-control" />
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="agmFrequency" class="form-control" onchange="refreshForm();"></select>
                </div>
                <div class="form-group">
                    <label>Starting Date</label>
                    <input type="text" id="agmStartDate" class="date-picker form-control" />
                </div>
                <div class="form-group" id="fgAgreedAmount">
                    <label>Agreed Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmAgreedAmount" class="form-control" onchange="updateAgreedAmount();"/>
                    </div>
                </div>
                <div class="form-group">
                    <label>No. of installments</label>
                    <input type="text" id="agmNumberOfInstallments" class="form-control" onchange="updateCalculation(3);" />
                </div>
            </div>

            <div style="width:45%;margin-right:10px;float:right;height:auto">
                <div class="form-group">
                    <label>Total Debt Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" class="form-control" id="agmTotalDebtAmount" class="form-control" disabled>
                    </div>
                </div>
                <div id="fcyWeekly" style="display: inline-block">
                    <div class="form-group">
                        <label>Day of week</label>
                        <select id="agmDayOfWeek" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                </div>
                <div id="fcyMonthly" style="display: none">
                    <div class="form-group">
                        <label>Day of month</label>
                        <select id="agmDayOfMonth" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                </div>
                <div id="fcyOneOff" style="display: none">
                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="text" id="agmPaymentDate" class="date-picker form-control" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="agmPaymentMethod" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Initial Downpayment Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmStartAmount" class="form-control" onchange="updateCalculation(1);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Installment Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmInstallmentAmount" class="form-control" onchange="updateCalculation(2);">
                    </div>
                </div>
                <div class="form-group" style="visibility: visible;">
                    <label>Last Payment Amount</label>
                    <div class="form-group input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-gbp"></i>
                        </span>
                        <input type="text" id="agmLastAmount" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="width:100%;clear:both;">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createDebtAttribute();" id="formCreate">Create Arrangement</button>
            </div>
        </div>
        
        <script>
            
            var currentDate = formatDate();
            console.log('SELECTED_DEBT_VALUE: ' + $('#debtRowTotalValue').val() + ', CURRENT_DATE: ' + currentDate);

            //$('#agmTotalDebtAmount').val(1111);
            $('#agmTotalDebtAmount').val($('#debtRowTotalValue').val());
            $('#agmAgreedAmount').val($('#debtRowTotalValue').val());
            $("#agmStartAmount").val('0');
            $("#agmLastAmount").val('0');
            $("#agmInstallmentAmount").val('0');
            $("#agmNumberOfInstallments").val('1');

            $("#agmAgreementDate").datepicker();
            $("#agmStartDate").datepicker();
            $("#agmPaymentStartDate").datepicker();
            $("#agmPaymentDate").datepicker();

            $("#agmStartDate").val(currentDate);
            $("#agmPaymentStartDate").val(currentDate);
            $("#agmPaymentDate").val(currentDate);
            $("#agmAgreementDate").val(currentDate);
            
            loadArrangementFrequenciesList();
            loadArrangementPaymentMethodList();

            function updateCalculation(callingId) {

                var agreedAmount = $("#agmAgreedAmount").val();
                var installmentAmount = $("#agmInstallmentAmount").val();
                var installmentCount = $("#agmNumberOfInstallments").val();
                var deposit = $("#agmStartAmount").val();
                var lastAmount = $("#agmLastAmount").val();

                if (deposit == 'undefined') { $("#agmStartAmount").val('0'); }
                if (lastAmount == 'undefined') { $("#agmLastAmount").val('0'); }
                if (installmentCount == 'undefined') { $("#agmNumberOfInstallments").val('1'); }
                if (installmentAmount == 'undefined') { $("#agmInstallmentAmount").val('0'); }
                if (agreedAmount == 'undefined') { $("#agmAgreedAmountagmLastAmount").val('0'); }

                console.log("[AGREED_AMOUNT:" + agreedAmount + ", INSTALLMENT_AMOUNT:" + installmentAmount + ", INSTALLMENT_COUNT:" + installmentCount + ", PAID_UPFRONT:" + deposit + ", LAST_AMOUNT:" + lastAmount + "]");

                // INSTALLMENT AMOUNT
                if (callingId == 2) {
                    var toClear = (agreedAmount - deposit);
                    var rawInstall = toClear / installmentAmount;
                    var cleanInstall = rawInstall.toFixed(0);
                    var cleanAllItem = cleanInstall * installmentAmount;
                    var leftOver = agreedAmount - cleanAllItem;
                    console.log("[TO_CLEAR:" + toClear + ", RAW_INSTALLMENT_AMOUNT:" + rawInstall + ", CLEAN_INSTALLMENT_COUNT:" + cleanInstall + ", CLEAN_INSTALLMENT_AMOUNT:" + cleanAllItem + ", LAST_PAYMENT:" + leftOver + "]");
                    $("#agmNumberOfInstallments").val(cleanInstall);
                    $("#agmLastAmount").val(leftOver);
                }
                // NUMBER OF INSTALLMENTS
                if (callingId == 3 || callingId == 1) {
                    var rawCalculation = (agreedAmount - deposit) / installmentCount; // 176.833 = (1111 - 50) / 12
                    var cleanCalculation = +rawCalculation.toFixed(2); // 176.83
                    var cleanInstallments = cleanCalculation * installmentCount; // 1060.98 = 176.83 * 12
                    var rawDifference = (agreedAmount - deposit) - cleanInstallments; // 0.019999
                    var cleanDifference = +rawDifference.toFixed(2); // 0.02
                    var firstPayment = cleanDifference + cleanCalculation; // Initial  amount includes the difference
                    console.log("[rawCalculation:" + rawCalculation + ", cleanCalculation:" + cleanCalculation + ", cleanInstallments:" + cleanInstallments + ", rawDifference:" + rawDifference + ", cleanDifference:" + cleanDifference + ", firstPayment:" + firstPayment + "]");
                    $("#agmInstallmentAmount").val(cleanCalculation.toFixed(2));
                    $("#agmLastAmount").val(firstPayment.toFixed(2));
                }
            }
            function updateAgreedAmount() {
                var agreedAmount = $('#agmAgreedAmount').val();
                var totalAmount = $('#agmTotalDebtAmount').val();
                if (agreedAmount > totalAmount) {
                    $('#fgAgreedAmount').addClass('has-error');
                    $("#formCreate").prop('disabled', true);
                } else {
                    $('#fgAgreedAmount').removeClass('has-error');
                    $("#formCreate").prop('disabled', false);
                }
            }
            function formatDate() {
                var today = new Date();
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                var yyyy = today.getFullYear();

                if (dd < 10) {
                    dd = '0' + dd;
                }
                if (mm < 10) {
                    mm = '0' + mm;
                }

                return dd + '/' + mm + '/' + yyyy;
            }
            function refreshForm() {
                var selectedIndex = $("#agmFrequency").val();
                if (selectedIndex == 1) {
                    $("#fcyWeekly").show();
                    $("#fcyMonthly").hide();
                    $("#fcyOneOff").hide();
                }
                if (selectedIndex == 2) {
                    $("#fcyWeekly").hide();
                    $("#fcyMonthly").show();
                    $("#fcyOneOff").hide();
                }
                if (selectedIndex == 3) {
                    $("#fcyWeekly").hide();
                    $("#fcyMonthly").hide();
                    $("#fcyOneOff").show();
                }
            }

        </script>

    </body>

</html>
